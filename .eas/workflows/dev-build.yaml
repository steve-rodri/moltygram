name: Development Build for Device

concurrency:
  cancel_in_progress: true
  group: ${{ workflow.filename }}-${{ github.ref }}

on:
  push:
    branches:
      - main

jobs:
  # Calculate fingerprint to check if native code changed
  fingerprint:
    name: Calculate Fingerprint
    type: fingerprint
    environment: development

  # # Try to find existing Android development build with matching fingerprint
  # android_get_build:
  #   name: Check Android Fingerprint
  #   needs: [fingerprint]
  #   type: get-build
  #   params:
  #     fingerprint_hash: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
  #     platform: android
  #     profile: dev
  #   environment: development

  # # Build Android only if fingerprint differs (native code changed)
  # android_build:
  #   name: Build Android Development
  #   needs: [android_get_build]
  #   if: ${{ !needs.android_get_build.outputs.build_id }}
  #   type: build
  #   params:
  #     platform: android
  #     profile: dev
  #   environment: development

  # Try to find existing iOS development build with matching fingerprint
  ios_get_build:
    name: Check iOS Fingerprint
    needs: [fingerprint]
    type: get-build
    params:
      fingerprint_hash: ${{ needs.fingerprint.outputs.ios_fingerprint_hash }}
      platform: ios
      profile: dev
    environment: development

  # Build iOS only if fingerprint differs (native code changed)
  ios_build:
    name: Build iOS Development
    needs: [ios_get_build]
    if: ${{ !needs.ios_get_build.outputs.build_id }}
    type: build
    params:
      platform: ios
      profile: dev
    environment: development

  # notify_slack_android_build:
  #   name: Notify Slack - Android Build
  #   needs: [android_build]
  #   if: ${{ env.SLACK_WEBHOOK_URL }}
  #   type: slack
  #   params:
  #     channel: ${{ env.SLACK_CHANNEL || 'retro-insta-builds' }}
  #     webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
  #     message: |
  #       ðŸ”¨ Android development build created!

  #       *Commit*: ${{ github.event.head_commit.message }}
  #       *Profile*: dev
  #       *Platform*: Android
  #       ðŸ“² Install: https://expo.dev/accounts/${{ env.EXPO_ACCOUNT }}/projects/retro-insta/builds/${{ needs.android_build.outputs.build_id }}

  notify_slack_ios_build:
    name: Notify Slack - iOS Build
    needs: [ios_build]
    if: ${{ env.SLACK_WEBHOOK_URL }}
    type: slack
    params:
      channel: ${{ env.SLACK_CHANNEL || 'retro-insta-builds' }}
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ðŸ”¨ iOS development build created!

        *Commit*: ${{ github.event.head_commit.message }}
        *Profile*: dev
        *Platform*: iOS
        ðŸ“² Install: https://expo.dev/accounts/${{ env.EXPO_ACCOUNT }}/projects/retro-insta/builds/${{ needs.ios_build.outputs.build_id }}
